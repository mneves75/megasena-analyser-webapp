# ============================================================================
# Staging Docker Compose Configuration (Standalone)
# Uses Bun runtime throughout with distroless image
# Usage: docker compose -f docker-compose.staging.yml up -d
# Domain: staging.megasena-analyzer.com.br (via Caddy reverse proxy)
# NOTE: This is a STANDALONE config, not an override, to avoid port conflicts
# ============================================================================

services:
  app:
    container_name: megasena-analyzer-staging

    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1

    # Staging ports (container uses 80 internally for Next.js)
    # Production: 3000:80, 3301:3201
    # Staging: 3100:80, 3401:3201
    ports:
      - "3100:80"
      - "3401:3201"

    environment:
      - NODE_ENV=production
      - PORT=80
      - API_PORT=3201
      - API_HOST=localhost
      - DATABASE_PATH=/app/db/mega-sena.db
      - NEXT_PUBLIC_BASE_URL=https://staging.megasena-analyzer.com.br
      - NEXT_TELEMETRY_DISABLED=1
      - ALLOWED_ORIGINS=https://staging.megasena-analyzer.com.br

    volumes:
      - ./db:/app/db

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "bun", "-e", "fetch('http://localhost:3201/api/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Lower resource limits for staging (optimized for Bun distroless)
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '0.5'
          memory: 320M
        reservations:
          cpus: '0.25'
          memory: 160M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

networks:
  default:
    name: megasena_staging_network
